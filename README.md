# SourceryTemplates

This repository contains some templates (in the `Templates/` directory) to use for Code Generation in Swift with [Sourcery](http://github.com/krzysztofzablocki/Sourcery).

You can see them in action by opening the `TemplatesDemo.xcodeproj` Xcode project: its `UnitTests` target contains some use case examples for each template, and some code using the generated code in each associated `XCTestCase`.

## Type Erasure

This template provides type erasure to any protocol you annotated accordingly.

### Usage

* Annotate the protocol to type-erase using `// sourcery: TypeErase = X` where `X` is the `associatedtype` to erase
* Use the template in [`Templates/TypeErase.stencil`](https://github.com/AliSoftware/SourceryTemplates/blob/master/Templates/TypeErase.stencil) with [Sourcery](http://github.com/krzysztofzablocki/Sourcery) to generate Type-Erased code for this annotated protocol(s)
* Add the generated `TypeErase.generated.swift` file to your Xcode project
* Profit!

### Examples

You can find some examples in the [`UnitTests/TypeErasure`](https://github.com/AliSoftware/SourceryTemplates/tree/master/UnitTests/TypeErasure) directory in this repo, like those:

```swift
// sourcery: TypeErase = PokemonType
protocol Pokemon {
  associatedtype PokemonType
  func attack(move: PokemonType)
}
```

```swift
// sourcery: TypeErase = Model
protocol Row {
  associatedtype Model

  var sizeLabelText: String { get set }

  func configure(model: Model)
}
```

You can look at the [file generated by Sourcery](https://github.com/AliSoftware/SourceryTemplates/blob/master/TypeErasure/UnitTests/Generated/TypeErase.generated.swift) from those examples using the provided [`Templates/TypeErase.stencil`](https://github.com/AliSoftware/SourceryTemplates/blob/master/Templates/TypeErase.stencil) template. Magic! ðŸŽ©âœ¨

### More Info

This is a first draft of the template, so please don't hesitate to improve it.

I haven't tested a lot of real-world use cases yet so some corner cases are probably missing but feel free to submit a PR to fix them!

The template generates the same code structure as the one explained in [this BigNerdRanch article](https://www.bignerdranch.com/blog/breaking-down-type-erasures-in-swift/) that inspired me to come up with a working template.

You can also find more information about Type-Erasure by watching [Gwendolyn's talk at Try! Swift](https://news.realm.io/news/tryswift-gwendolyn-weston-type-erasure/) â€” from which I borrowed the Pokemon examples to test that template.

## AutoInterface

This template allows to auto-generate a protocol matching the API of a `class`/`struct`.

### Usage

* Create an empty phantom protocol `protocol AutoInterface {}` somewhere in your code.
* Make your classes or structs conform to `AutoInterface` to opt-in
* Optionally, you can customize the name of the generated `protocol` for each type using annotations:
  * By default, the generated protocol as the same name as the type it was generated from, but prefixed with an `I` (e.g. `protocol IWebService` for `class WebService: AutoInterface`
  * You can use `// sourcery: AutoInterfacePrefix = â€¦` to change that prefix
  * You can use `// sourcery: AutoInterfaceSuffix = â€¦` to add a suffix
  * You can use `// sourcery: AutoInterface = â€¦` to force an exact name (in that case the `AutoInterfacePrefix` & `AutoInterfaceSuffix` are ignored if present)
* Use the template in [`Templates/AutoInterface.stencil`](https://github.com/AliSoftware/SourceryTemplates/blob/master/Templates/AutoInterface.stencil) with [Sourcery](http://github.com/krzysztofzablocki/Sourcery) to generate a `protocol` for each opted-in type and automatically make your type conform to that new protocol
* Add the generated `AutoInterface.generated.swift` file to your Xcode project
* Profit!

### Examples

You can find some examples in the [`UnitTests/AutoInterface`](https://github.com/AliSoftware/SourceryTemplates/tree/master/UnitTests/AutoInterface) directory in this repo, like this:

```swift
class UserWSClient: AutoInterface {
  struct User {
    let id: Int
    let name: String
  }

  let baseURL: URL = URL(string: "https://example.com/api")!
  
  func fetchUsers() -> [User] {
    return (0..<10).map { User(id: $0, name: "User\($0)") }
  }

  func fetchUser(id: Int) -> User? {
    return User(id: id, name: "User\(id)")
  }
}
```

Will generate a `protocol IUserWSClient` containing all the functions and properties of your type and make your type conform to that protocol:

```swift
protocol IUserWSClient {
	var baseURL: URL { get }
	func fetchUsers() -> [WSClient.UserWSClient.User]
	func fetchUser(id: Int) -> WSClient.UserWSClient.User?
}
extension UserWSClient: IUserWSClient {}
```

You can look at the [file generated by Sourcery](https://github.com/AliSoftware/SourceryTemplates/blob/master/UnitTests/Generated/AutoInterface.generated.swift) from this example using the provided [`Templates/AutoInterface.stencil`](https://github.com/AliSoftware/SourceryTemplates/blob/master/Templates/AutoInterface.stencil) template. Magic! ðŸŽ©âœ¨

## AutoKeyPathSchema

This template allows to auto-generate a `static let schema` property containing an array of `PartialKeyPath` to all the type's instance variables.

_Note that `PartialKeyPath` is a new feature of **Swift 4**, so this template needs the Swift 4 toolchain to work. It won't compile with Xcode 9 beta 1 though, as subscripting for `AnyKeyPath` / `PartialKeyPath` didn't make it to this release, but should with with swift.org master snapshot already._

Inspired by https://twitter.com/jckarter/status/868195828955062272

### Usage

* Create an empty phantom protocol `protocol AutoKeyPathSchema {}` somewhere in your code.
* Make your classes or structs conform to `AutoKeyPathSchema` to opt-in
* Use the template in [`Templates/AutoKeyPathSchema.stencil`](https://github.com/AliSoftware/SourceryTemplates/blob/master/Templates/AutoKeyPathSchema.stencil) with [Sourcery](http://github.com/krzysztofzablocki/Sourcery) to generate the schemas for all opt-in types
* Add the generated `AutoKeyPathSchema.generated.swift` file to your Xcode project
* Profilt!

### Examples

You can find some examples in the [`UnitTests/AutoKeyPathSchema`](https://github.com/AliSoftware/SourceryTemplates/tree/master/UnitTests/AutoKeyPathSchema) directory in this repo, like this:

```swift
struct Point: AutoKeyPathSchema {
  var x: Double, y: Double
}
```

Will generate the following implementation automatically using Sourcery:

```swift
protocol KeyPathSchema {
  static var schema: [PartialKeyPath<Self>] { get }
}

extension Point: KeyPathSchema, Hashable {
  static let schema: [PartialKeyPath<Point>] = [
    \Point.x, \Point.y,
  ]
}

extension Hashable where Self: KeyPathSchema {
  static func ==(a: Self, b: Self) -> Bool {
    for key in Self.schema {
      guard let aValue = a[keyPath: key] as? AnyHashable,
        let bValue = b[keyPath: key] as? AnyHashable,
        aValue == bValue
        else {
          return false
      }
    }
    return true
  }

  var hashValue: Int {
    var hash = unsafeBitCast(Self.self, to: Int.self)
    for key in Self.schema {
      if let value = self[keyPath: key] as? AnyHashable {
        // You should use a real hash combining function here
        hash = hash &* 17 ^ value.hashValue
      }
    }
    return hash
  }
}
```

## Other templates

* [Sourcery itself has some template examples](https://github.com/krzysztofzablocki/Sourcery/tree/master/Templates)
* You can also find a template by **@Liquidsoul** [on his own repo](https://github.com/Liquidsoul/Sourcery-AutoJSONSerializable) to auto-generate code for JSON serialization & deserialization.
